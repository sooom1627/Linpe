# アプリケーションテスト

このディレクトリには、アプリケーションのルーティングとナビゲーションに関連するテストが含まれています。

## ディレクトリ構造

```
app/__tests__/
├── helpers/         # テスト用ヘルパー関数とモックの定義
│   └── setup.ts     # 共通のモック設定とヘルパー関数
├── routes/          # ルート固有のテスト
│   ├── authenticated.test.tsx  # 認証済みユーザーのルーティングテスト
│   └── public.test.tsx         # 未認証ユーザーのルーティングテスト
└── protected.test.tsx  # 保護されたルートへのアクセス制御テスト
```

## テスト概要

### ルーティングテスト

アプリケーションは以下の3つの主要なルーティングシナリオをテストしています：

1. **保護されたルート** (`protected.test.tsx`)

   - 未認証ユーザーが保護されたルートにアクセスしようとすると、ログイン画面にリダイレクトされることを確認
   - 認証済みユーザーは保護されたルートにアクセスできることを確認

2. **認証済みユーザーのルート** (`routes/authenticated.test.tsx`)

   - 認証済みユーザーがログインページにアクセスすると、保護されたルートにリダイレクトされることを確認
   - 認証済みユーザーは保護されたルートに正常にアクセスできることを確認

3. **公開ルート** (`routes/public.test.tsx`)
   - 未認証ユーザーはログインページやサインアップページなどの公開ルートにアクセスできることを確認

### ヘルパーとモック

`helpers/setup.ts`
には、テストで使用される共通のモックとヘルパー関数が定義されています：

- **ルーターモック**: `useRouter`、`useSegments` などの Expo
  Router フックのモック
- **セッションモック**: 認証セッションのモック
- **コンテキストモック**: `SessionProvider` や `useSessionContext`
  などのコンテキストのモック

## テスト実行方法

テストを実行するには、以下のコマンドを使用します：

```bash
# すべてのテストを実行
npm test

# 特定のテストファイルを実行
npm test -- app/__tests__/protected.test.tsx

# 特定のディレクトリのテストを実行
npm test -- app/__tests__/routes
```

## テスト作成のベストプラクティス

1. **モックの共通化**

   - 共通のモックは `helpers/setup.ts` に定義し、テスト間で再利用する
   - 複雑なモックは関数として抽象化し、テストコードを簡潔に保つ

2. **テストの構造化**

   - 各テストは「準備（Arrange）」「実行（Act）」「検証（Assert）」の3ステップで構造化する
   - `beforeEach` と `afterEach` を使用して、テスト間の状態をリセットする

3. **非同期処理のテスト**

   - `act` と `jest.runAllTimers()`
     を組み合わせて、タイマーベースの非同期処理をテストする
   - `waitFor` を使用して、非同期の状態変化を待機する

4. **日本語のテスト記述**
   - テストの説明は日本語で記述し、テストの目的を明確に伝える
   - テスト名は「〜すること」の形式で、期待される動作を表現する

## 注意点

- テスト内で `setTimeout`
  などの非同期処理をテストする場合は、`jest.useFakeTimers()` と
  `jest.runAllTimers()` を使用する
- モックは各テストの前にリセットし、テスト間の干渉を防ぐ
- 複雑なコンポーネントのテストでは、小さな単位に分割してテストすることを検討する
